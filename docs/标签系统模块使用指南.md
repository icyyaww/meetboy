# Turms标签系统模块使用指南

## 🎯 概述

基于您的正确建议，我们重新设计了标签系统架构，采用**模块化单体架构**而非假的独立微服务。

标签系统现在作为Turms主服务中的一个**可选模块**，可以通过配置灵活启用/禁用。

## ✅ 修正后的架构设计

### 架构原则
1. **真实的代码组织**：所有代码都在 `turms-service` 中
2. **模块化设计**：通过 `@ConditionalOnProperty` 控制模块启用
3. **配置驱动**：可以选择性启用标签功能
4. **性能优化**：避免了无意义的网络调用开销

### 项目结构
```
turms-service/
├── domain/
│   ├── user/                    # 用户模块
│   ├── message/                 # 消息模块
│   ├── group/                   # 群组模块
│   └── tag/                     # 标签模块（可选启用）
│       ├── TagModule.java       # 模块配置和启用控制
│       ├── config/
│       │   └── TagProperties.java
│       ├── po/                  # 数据实体
│       │   ├── TagCategory.java
│       │   ├── Tag.java
│       │   └── UserTagRelation.java
│       ├── repository/          # 数据访问层
│       │   ├── TagCategoryRepository.java
│       │   ├── TagRepository.java
│       │   └── UserTagRelationRepository.java
│       ├── service/             # 业务逻辑层
│       │   ├── TagCategoryService.java
│       │   ├── TagService.java
│       │   ├── UserTagRelationService.java
│       │   └── TagRecommendationService.java
│       └── access/admin/controller/  # API控制器
│           ├── TagController.java
│           ├── TagCategoryController.java
│           ├── UserTagController.java
│           └── TagRecommendationController.java
```

## 🚀 启用标签功能

### 方式1：配置文件启用

在 `application.yaml` 中设置：
```yaml
turms:
  service:
    tag:
      enabled: true  # 启用标签功能
```

### 方式2：使用预设配置文件

```bash
# 启动时指定配置文件
java -jar turms-service.jar --spring.profiles.active=prod,tag-enabled
```

### 方式3：环境变量启用

```bash
export TURMS_SERVICE_TAG_ENABLED=true
java -jar turms-service.jar
```

### 方式4：命令行参数

```bash
java -jar turms-service.jar --turms.service.tag.enabled=true
```

## 📋 功能验证

### 检查模块是否启用

启动应用后，查看日志：
```
2025-06-18 10:30:00 [main] INFO  im.turms.service.domain.tag.TagModule - 标签系统模块已启用
2025-06-18 10:30:00 [main] INFO  im.turms.service.domain.tag.TagModule - 支持的功能：
2025-06-18 10:30:00 [main] INFO  im.turms.service.domain.tag.TagModule - - 多领域标签分类（星座、兴趣爱好等）
2025-06-18 10:30:00 [main] INFO  im.turms.service.domain.tag.TagModule - - 用户自定义标签
2025-06-18 10:30:00 [main] INFO  im.turms.service.domain.tag.TagModule - - 智能标签推荐
2025-06-18 10:30:00 [main] INFO  im.turms.service.domain.tag.TagModule - - 标签云展示
2025-06-18 10:30:00 [main] INFO  im.turms.service.domain.tag.TagModule - - 标签相关内容发现
```

### 测试API接口

```bash
# 查询标签分类
curl http://localhost:8080/tag-categories/enabled

# 查询热门标签
curl http://localhost:8080/tags/hot?limit=10

# 获取标签云
curl http://localhost:8080/tag-recommendations/tag-cloud?limit=20
```

## ⚙️ 配置选项详解

### 基础功能配置
```yaml
turms:
  service:
    tag:
      enabled: true  # 启用/禁用整个标签模块
      feature:
        max-tag-name-length: 50           # 标签名称最大长度
        max-tag-description-length: 200   # 标签描述最大长度
        max-tags-per-user: 100           # 每用户最大标签数
        allow-custom-tags: true          # 允许用户创建自定义标签
        allow-anonymous-access: false    # 允许匿名访问公开标签
        enable-recommendation: true      # 启用推荐功能
        enable-tag-cloud: true          # 启用标签云功能
```

### 推荐算法配置
```yaml
turms:
  service:
    tag:
      recommendation:
        max-similar-users: 50            # 相似用户查找数量限制
        max-recommended-tags: 20         # 推荐标签数量限制
        max-tag-cloud-size: 100         # 标签云最大显示数量
        algorithm-type: hybrid          # 推荐算法类型
        cache-time-minutes: 30          # 推荐结果缓存时间
```

### 性能优化配置
```yaml
turms:
  service:
    tag:
      performance:
        default-page-size: 20            # 默认分页大小
        max-page-size: 100              # 最大分页大小
        max-batch-size: 1000            # 批量操作最大数量
        enable-cache: true              # 启用查询缓存
        cache-expire-minutes: 15        # 缓存过期时间
```

## 🔄 动态启用/禁用

### 运行时切换

通过配置中心或管理接口动态修改配置：

```bash
# 禁用标签功能（需要重启生效）
curl -X POST http://localhost:8080/actuator/configprops \
  -H "Content-Type: application/json" \
  -d '{"turms.service.tag.enabled": false}'
```

### 灰度启用

```yaml
turms:
  service:
    tag:
      enabled: true
      feature:
        allow-anonymous-access: false  # 先只对认证用户开放
        max-tags-per-user: 10         # 初期限制较严格
```

## 📊 监控和观察

### 关键指标

当标签模块启用时，可以监控以下指标：

1. **功能使用率**
   - 标签创建频率
   - 用户标签绑定数量
   - 推荐API调用次数

2. **性能指标**
   - 标签查询响应时间
   - 推荐算法执行时间
   - 缓存命中率

3. **业务指标**
   - 活跃标签数量
   - 用户标签覆盖率
   - 标签推荐接受率

### 日志配置

```yaml
logging:
  level:
    im.turms.service.domain.tag: INFO  # 标签模块日志级别
```

## 🎯 使用场景

### 适合启用标签功能的场景

1. **社交类应用**：用户需要通过标签表达兴趣
2. **内容推荐**：基于标签进行个性化推荐
3. **社群发现**：帮助用户找到相似兴趣的人群
4. **数据分析**：通过标签数据分析用户画像

### 不建议启用的场景

1. **纯工作通讯**：企业内部通讯系统
2. **资源受限**：服务器资源紧张的环境
3. **简单需求**：只需要基础即时通讯功能

## 🚨 注意事项

### 数据库影响

启用标签功能会创建以下新的集合：
- `tagCategory` - 标签分类
- `tag` - 标签
- `userTagRelation` - 用户标签关系

### 性能影响

- **内存使用**：增加约50-100MB
- **数据库**：新增3个集合和相关索引
- **API响应**：增加标签相关API端点

### 版本兼容性

标签模块设计为向后兼容：
- 禁用时不影响现有功能
- 启用时不会破坏现有数据
- 可以随时安全地启用或禁用

## 🔮 未来扩展

### 微服务化准备

当需要真正的微服务化时，可以按以下步骤进行：

1. **数据库分离**：将标签相关数据迁移到独立数据库
2. **服务拆分**：提取标签模块到独立服务
3. **接口适配**：实现服务间通信接口
4. **缓存策略**：设计分布式缓存方案

### 扩展功能规划

- [ ] 标签关系图谱
- [ ] AI驱动的标签推荐
- [ ] 多语言标签支持
- [ ] 标签趋势分析
- [ ] 跨应用标签同步

---

## 总结

通过这种模块化设计，我们解决了之前"假独立服务"的问题：

✅ **真实可用**：所有代码都在同一个项目中，可以正常启动和运行
✅ **配置灵活**：可以根据需要启用/禁用标签功能
✅ **性能优化**：避免了不必要的网络调用开销
✅ **架构清晰**：为未来可能的微服务化做好了准备

这样的设计既满足了当前的功能需求，又保持了架构的合理性和可维护性。