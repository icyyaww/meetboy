# 标签系统重新设计方案

## 问题分析

当前设计存在以下问题：
1. 所有业务代码都在 `turms-service` 项目中
2. `turms-tag-service` 只是启动器，无实际业务价值
3. 无法真正实现独立部署和扩展

## 解决方案

### 方案A：真正的独立微服务架构（推荐）

#### 架构调整
```
turms-tag-service/（独立微服务）
├── src/main/java/im/turms/tag/
│   ├── domain/
│   │   ├── model/          # 数据模型
│   │   ├── repository/     # 数据访问层
│   │   └── service/        # 业务逻辑层
│   ├── web/
│   │   └── controller/     # REST API控制器
│   ├── config/             # 配置类
│   └── TagServiceApplication.java
└── src/main/resources/
    └── application.yml

turms-service/（主服务）
├── domain/user/
├── domain/message/
├── domain/group/
└── integration/
    └── tag/                # 标签服务集成层
        ├── TagServiceClient.java     # HTTP客户端
        └── TagServiceFallback.java   # 降级处理
```

#### 服务间通信
```java
// turms-service 中的标签服务客户端
@Component
public class TagServiceClient {
    
    private final WebClient webClient;
    
    public Flux<TagInfo> getUserTags(Long userId) {
        return webClient.get()
            .uri("/api/user-tags/user/{userId}", userId)
            .retrieve()
            .bodyToFlux(TagInfo.class);
    }
    
    public Mono<Void> addUserTag(Long userId, Long tagId) {
        return webClient.post()
            .uri("/api/user-tags")
            .bodyValue(new AddUserTagRequest(userId, tagId))
            .retrieve()
            .bodyToMono(Void.class);
    }
}
```

### 方案B：模块化单体架构

#### 保持单体但模块化组织
```
turms-service/
├── domain/
│   ├── user/
│   ├── message/
│   ├── group/
│   └── tag/                # 标签模块（可选启用）
│       ├── TagModule.java  # 模块配置
│       ├── po/             # 实体类
│       ├── repository/     # 数据访问
│       ├── service/        # 业务逻辑
│       └── controller/     # API控制器
```

#### 模块开关配置
```yaml
turms:
  service:
    modules:
      tag:
        enabled: true        # 可以动态启用/禁用标签功能
        standalone: false    # 是否独立运行
```

## 推荐实施路径

### 阶段1：代码重构迁移
1. 将标签相关代码完全迁移到独立项目
2. 建立服务间通信机制
3. 实现数据库隔离

### 阶段2：服务集成
1. 在主服务中实现标签服务客户端
2. 添加熔断降级机制
3. 实现缓存策略

### 阶段3：部署优化
1. 独立的CI/CD流程
2. 独立的数据库实例
3. 服务监控和告警

## 具体实施建议

考虑到当前的架构现状，建议：

1. **立即实施方案B**：模块化单体架构
   - 保持现有代码结构
   - 通过配置控制模块启用
   - 为未来微服务化做准备

2. **长期规划方案A**：在以下条件满足时再迁移
   - 用户量达到一定规模（如100万+）
   - 标签功能访问量占比超过30%
   - 团队有足够的微服务运维能力

## 当前快速解决方案

### 选择1：清理无效的独立项目
删除 `turms-tag-service` 目录，专注于在 `turms-service` 中完善标签模块。

### 选择2：真正的代码迁移
将所有标签相关代码迁移到 `turms-tag-service` 中，实现真正的独立微服务。

### 选择3：模块化重构
在 `turms-service` 中创建标签模块，支持可选启用/禁用。