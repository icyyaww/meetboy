# Turms æ–°ä¸šåŠ¡åŠŸèƒ½å¼€å‘æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†åœ¨ Turms å³æ—¶é€šè®¯ç³»ç»Ÿä¸­æ·»åŠ æ–°ä¸šåŠ¡åŠŸèƒ½çš„å®Œæ•´æµç¨‹ã€‚

## ğŸ“ æœ€æ–°ä»£ç ä¿®æ”¹è®°å½•

### 2025-06-18 æ¶æ„ä¼˜åŒ–åˆ†æ
- **ä¿®æ”¹å†…å®¹**ï¼šåˆ›å»ºäº†ç”¨æˆ·æ¨¡å—ä¸æ¶ˆæ¯æ¨¡å—æ‹†åˆ†éš¾åº¦è¯„ä¼°æŠ¥å‘Š
- **æ–°å¢æ–‡ä»¶**ï¼š`/home/icyyaww/program/meetboy/docs/architecture-optimization/04-user-messaging-module-separation-difficulty-assessment.md`
- **ä¿®æ”¹åŸå› **ï¼šæ·±å…¥åˆ†æTurmsç³»ç»Ÿå¾®æœåŠ¡åŒ–æ‹†åˆ†çš„æŠ€æœ¯å¯è¡Œæ€§å’Œå®æ–½éš¾åº¦ï¼Œä¸ºåç»­æ¶æ„ä¼˜åŒ–å†³ç­–æä¾›è¯¦ç»†çš„æŠ€æœ¯ä¾æ®
- **å½±å“èŒƒå›´**ï¼šæ¶æ„è®¾è®¡æ–‡æ¡£ï¼Œä¸æ¶‰åŠä»£ç å˜æ›´
- **ä¸»è¦å‘ç°**ï¼š
  - ç”¨æˆ·æ¨¡å—ä¸æ¶ˆæ¯æ¨¡å—é«˜åº¦è€¦åˆï¼Œæ‹†åˆ†éš¾åº¦æé«˜
  - å½“å‰ä¸å»ºè®®è¿›è¡Œå¾®æœåŠ¡åŒ–æ‹†åˆ†
  - æ¨èé‡‡ç”¨æ¨¡å—åŒ–é‡æ„çš„æ¸è¿›å¼ä¼˜åŒ–æ–¹æ¡ˆ
- **æŠ€æœ¯è¦ç‚¹**ï¼š
  - ä»£ç å±‚é¢ï¼š48ä¸ªæ–‡ä»¶å¼•ç”¨useræ¨¡å—ï¼Œ18ä¸ªæ–‡ä»¶å¼•ç”¨messageæ¨¡å—
  - æ•°æ®å±‚é¢ï¼šæ¶ˆæ¯è¡¨é€šè¿‡sender_idå’Œtarget_idå¼ºå…³è”ç”¨æˆ·è¡¨
  - æœåŠ¡å±‚é¢ï¼šéœ€è¦å¤„ç†å¤æ‚çš„åˆ†å¸ƒå¼äº‹åŠ¡å’ŒçŠ¶æ€åŒæ­¥
  - æ€§èƒ½å½±å“ï¼šé¢„ä¼°å“åº”å»¶è¿Ÿå¢åŠ 2-5å€
  - å®æ–½æˆæœ¬ï¼šçº¦200ä¸‡æˆæœ¬ï¼Œ9ä¸ªæœˆå¼€å‘å‘¨æœŸ

## ğŸš€ å¼€å‘æµç¨‹æ¦‚è¿°

æ·»åŠ æ–°ä¸šåŠ¡åŠŸèƒ½éœ€è¦éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š
1. å®šä¹‰ Proto åè®®
2. ç”Ÿæˆä»£ç 
3. æœåŠ¡ç«¯å®ç°
4. ç½‘å…³å±‚é…ç½®  
5. å®¢æˆ·ç«¯ä½¿ç”¨
6. æ•°æ®åº“è®¾è®¡
7. é…ç½®ç®¡ç†
8. æµ‹è¯•
9. æ–‡æ¡£æ›´æ–°

## 1. ğŸ“‹ å®šä¹‰ Proto åè®®

### åˆ›å»ºæ–°çš„è¯·æ±‚ç±»å‹
```protobuf
// åœ¨ turms_request.proto ä¸­æ·»åŠ æ–°çš„è¯·æ±‚ç±»å‹
message CreateCustomBusinessRequest {
    optional string business_name = 1;
    optional string business_data = 2;
    repeated int64 target_user_ids = 3;
    optional int64 group_id = 4;
}

// åœ¨ TurmsRequest çš„ oneof ä¸­æ·»åŠ 
message TurmsRequest {
    // ... ç°æœ‰è¯·æ±‚ç±»å‹
    oneof kind {
        // ... ç°æœ‰çš„72ç§è¯·æ±‚
        CreateCustomBusinessRequest create_custom_business_request = 100;
        UpdateCustomBusinessRequest update_custom_business_request = 101;
        QueryCustomBusinessRequest query_custom_business_request = 102;
    }
}
```

### åˆ›å»ºå¯¹åº”çš„å“åº”å’Œé€šçŸ¥
```protobuf
// åœ¨ç›¸åº”çš„ proto æ–‡ä»¶ä¸­å®šä¹‰å“åº”
message CreateCustomBusinessResponse {
    optional int64 business_id = 1;
    optional int64 timestamp = 2;
}

// åœ¨é€šçŸ¥ä¸­æ·»åŠ 
message CustomBusinessNotification {
    optional int64 business_id = 1;
    optional string business_name = 2;
    optional int64 creator_id = 3;
}
```

### Proto è®¾è®¡åŸåˆ™
- æ–°å­—æ®µä½¿ç”¨ `optional` æ ‡è®°ä»¥ä¿æŒå‘åå…¼å®¹æ€§
- ä¸ºå­—æ®µåˆ†é…å”¯ä¸€çš„ç¼–å·
- é¿å…é‡å¤ä½¿ç”¨å·²åºŸå¼ƒçš„å­—æ®µç¼–å·
- ä½¿ç”¨æè¿°æ€§çš„å­—æ®µåç§°

## 2. ğŸ”§ ç”Ÿæˆä»£ç 

### é‡æ–°ç”Ÿæˆæ‰€æœ‰å®¢æˆ·ç«¯ä»£ç 
```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
./tools/generate_proto.sh

# æˆ–è€…å•ç‹¬ç”Ÿæˆç‰¹å®šå®¢æˆ·ç«¯
cd turms-client-js && npm run protoc:compile
cd turms-client-kotlin && ./generate_proto.sh
cd turms-client-dart && ./tool/generate_proto.sh
cd turms-client-swift && ./generate_proto.sh
cd turms-client-cpp && ./generate_proto.sh
```

### éªŒè¯ç”Ÿæˆç»“æœ
```bash
# æ£€æŸ¥ç”Ÿæˆçš„ Java æ–‡ä»¶
find . -name "*CustomBusiness*.java" -type f

# æ£€æŸ¥ç”Ÿæˆçš„ TypeScript æ–‡ä»¶  
find . -name "*custom-business*.ts" -type f
```

## 3. ğŸ—ï¸ æœåŠ¡ç«¯å®ç°

### åˆ›å»ºä¸šåŠ¡æœåŠ¡ç±»
```java
@Service
public class CustomBusinessService {
    
    private final CustomBusinessRepository customBusinessRepository;
    private final TurmsPropertiesManager propertiesManager;
    private final TurmsTaskExecutor taskExecutor;
    
    public CustomBusinessService(
            CustomBusinessRepository customBusinessRepository,
            TurmsPropertiesManager propertiesManager,
            TurmsTaskExecutor taskExecutor) {
        this.customBusinessRepository = customBusinessRepository;
        this.propertiesManager = propertiesManager;
        this.taskExecutor = taskExecutor;
    }
    
    public Mono<CreateCustomBusinessResponse> createCustomBusiness(
            Long requesterId,
            CreateCustomBusinessRequest request) {
        
        // 1. éªŒè¯è¯·æ±‚å‚æ•°
        if (StringUtil.isBlank(request.getBusinessName())) {
            return Mono.error(TurmsBusinessException
                .get(TurmsStatusCode.ILLEGAL_ARGUMENT, "Business name cannot be blank"));
        }
        
        // 2. æ£€æŸ¥ä¸šåŠ¡é…ç½®
        if (!propertiesManager.getLocalProperties()
                .getService().getCustomBusiness().isEnabled()) {
            return Mono.error(TurmsBusinessException
                .get(TurmsStatusCode.DISABLED_FUNCTION));
        }
        
        // 3. éªŒè¯æƒé™
        return checkPermission(requesterId, request)
            .then(customBusinessRepository.createBusiness(
                    requesterId, 
                    request.getBusinessName(),
                    request.getBusinessData(),
                    request.getTargetUserIdsList(),
                    request.hasGroupId() ? request.getGroupId() : null))
            .map(businessId -> CreateCustomBusinessResponse.newBuilder()
                .setBusinessId(businessId)
                .setTimestamp(System.currentTimeMillis())
                .build());
    }
    
    private Mono<Void> checkPermission(Long requesterId, CreateCustomBusinessRequest request) {
        // å®ç°æƒé™æ£€æŸ¥é€»è¾‘
        return Mono.empty();
    }
    
    public Mono<Void> deleteCustomBusiness(Long requesterId, Long businessId) {
        return customBusinessRepository.deleteByIdAndCreatorId(businessId, requesterId)
            .then();
    }
    
    public Flux<CustomBusiness> queryCustomBusinesses(
            Long requesterId, 
            QueryCustomBusinessRequest request) {
        return customBusinessRepository.findByCreatorId(requesterId)
            .take(request.hasLimit() ? request.getLimit() : 50);
    }
}
```

### æ·»åŠ è¯·æ±‚å¤„ç†å™¨
```java
@Component
public class CreateCustomBusinessRequestHandler 
        extends ClientRequestHandler<CreateCustomBusinessRequest> {

    private final CustomBusinessService customBusinessService;

    public CreateCustomBusinessRequestHandler(CustomBusinessService customBusinessService) {
        this.customBusinessService = customBusinessService;
    }

    @Override
    public Mono<RequestHandlerResult> handle(
            RequestHandlerResultFactory resultFactory,
            ClientRequest<CreateCustomBusinessRequest> clientRequest) {
        
        Long requesterId = clientRequest.requesterId();
        CreateCustomBusinessRequest request = clientRequest.turmsRequest()
            .getCreateCustomBusinessRequest();
            
        return customBusinessService.createCustomBusiness(requesterId, request)
            .map(response -> resultFactory.get(
                TurmsNotification.Data.newBuilder()
                    .setCreateCustomBusinessResponse(response)
                    .build()))
            .onErrorMap(throwable -> {
                if (throwable instanceof TurmsBusinessException) {
                    return throwable;
                }
                return TurmsBusinessException.get(TurmsStatusCode.SERVER_INTERNAL_ERROR);
            });
    }
}

@Component  
public class UpdateCustomBusinessRequestHandler
        extends ClientRequestHandler<UpdateCustomBusinessRequest> {
    // ç±»ä¼¼çš„å®ç°...
}

@Component
public class QueryCustomBusinessRequestHandler  
        extends ClientRequestHandler<QueryCustomBusinessRequest> {
    // ç±»ä¼¼çš„å®ç°...
}
```

### æ³¨å†Œè¯·æ±‚å¤„ç†å™¨
```java
// åœ¨ RequestHandlerManager ä¸­æ³¨å†Œæ–°çš„å¤„ç†å™¨
@PostConstruct
private void registerHandlers() {
    // ... ç°æœ‰å¤„ç†å™¨æ³¨å†Œ
    
    registerHandler(TurmsRequest.KindCase.CREATE_CUSTOM_BUSINESS_REQUEST, 
        CreateCustomBusinessRequestHandler.class);
    registerHandler(TurmsRequest.KindCase.UPDATE_CUSTOM_BUSINESS_REQUEST,
        UpdateCustomBusinessRequestHandler.class);  
    registerHandler(TurmsRequest.KindCase.QUERY_CUSTOM_BUSINESS_REQUEST,
        QueryCustomBusinessRequestHandler.class);
}
```

## 4. ğŸŒ ç½‘å…³å±‚é…ç½®

### æ·»åŠ è¯·æ±‚éªŒè¯å™¨ï¼ˆå¯é€‰ï¼‰
```java
@Component
public class CustomBusinessRequestValidator 
        implements ClientRequestTransformer {
    
    private static final Logger LOGGER = LoggerFactory.getLogger(CustomBusinessRequestValidator.class);
    
    @ExtensionPointMethod
    @Override
    public Mono<ClientRequest> transform(@NotNull ClientRequest clientRequest) {
        TurmsRequest.Builder builder = clientRequest.turmsRequestBuilder();
        
        if (builder.getKindCase() == TurmsRequest.KindCase.CREATE_CUSTOM_BUSINESS_REQUEST) {
            CreateCustomBusinessRequest request = builder.getCreateCustomBusinessRequest();
            
            // æ·»åŠ ç½‘å…³å±‚éªŒè¯é€»è¾‘
            if (request.getBusinessName().length() > 50) {
                LOGGER.warn("Business name too long: {}", request.getBusinessName());
                return Mono.error(TurmsBusinessException
                    .get(TurmsStatusCode.ILLEGAL_ARGUMENT, "Business name too long"));
            }
            
            // å¯ä»¥æ·»åŠ é™æµã€é»‘åå•æ£€æŸ¥ç­‰
            return checkRateLimit(clientRequest)
                .then(Mono.just(clientRequest));
        }
        
        return Mono.just(clientRequest);
    }
    
    private Mono<Void> checkRateLimit(ClientRequest clientRequest) {
        // å®ç°é™æµé€»è¾‘
        return Mono.empty();
    }
}
```

## 5. ğŸ“± å®¢æˆ·ç«¯ä½¿ç”¨

### JavaScript å®¢æˆ·ç«¯
```javascript
// è‡ªåŠ¨ç”Ÿæˆçš„å®¢æˆ·ç«¯ API
const turmsClient = new TurmsClient();

// è¿æ¥åˆ°æœåŠ¡å™¨
await turmsClient.userService.login(userId, password);

// ä½¿ç”¨æ–°çš„ä¸šåŠ¡åŠŸèƒ½
try {
    const response = await turmsClient.customBusinessService.createCustomBusiness({
        businessName: "æ–°ä¸šåŠ¡åŠŸèƒ½",
        businessData: JSON.stringify({ key: "value" }),
        targetUserIds: [123, 456],
        groupId: 789
    });
    
    console.log('ä¸šåŠ¡åˆ›å»ºæˆåŠŸï¼ŒID:', response.businessId);
} catch (error) {
    console.error('ä¸šåŠ¡åˆ›å»ºå¤±è´¥:', error);
}

// æŸ¥è¯¢ä¸šåŠ¡
const businesses = await turmsClient.customBusinessService.queryCustomBusinesses({
    limit: 10
});

// æ›´æ–°ä¸šåŠ¡
await turmsClient.customBusinessService.updateCustomBusiness({
    businessId: businessId,
    businessName: "æ›´æ–°åçš„ä¸šåŠ¡åç§°"
});
```

### Android/Kotlin å®¢æˆ·ç«¯
```kotlin
// è‡ªåŠ¨ç”Ÿæˆçš„å®¢æˆ·ç«¯ API
val turmsClient = TurmsClient()

// è¿æ¥åˆ°æœåŠ¡å™¨
turmsClient.userService.login(userId, password).block()

// ä½¿ç”¨æ–°çš„ä¸šåŠ¡åŠŸèƒ½
try {
    val response = turmsClient.customBusinessService.createCustomBusiness(
        businessName = "æ–°ä¸šåŠ¡åŠŸèƒ½",
        businessData = """{"key": "value"}""",
        targetUserIds = listOf(123L, 456L),
        groupId = 789L
    ).block()
    
    println("ä¸šåŠ¡åˆ›å»ºæˆåŠŸï¼ŒID: ${response.businessId}")
} catch (e: Exception) {
    println("ä¸šåŠ¡åˆ›å»ºå¤±è´¥: ${e.message}")
}

// æŸ¥è¯¢ä¸šåŠ¡
val businesses = turmsClient.customBusinessService.queryCustomBusinesses(
    limit = 10
).collectList().block()

// æ›´æ–°ä¸šåŠ¡  
turmsClient.customBusinessService.updateCustomBusiness(
    businessId = businessId,
    businessName = "æ›´æ–°åçš„ä¸šåŠ¡åç§°"
).block()
```

### Flutter/Dart å®¢æˆ·ç«¯
```dart
// è‡ªåŠ¨ç”Ÿæˆçš„å®¢æˆ·ç«¯ API
final turmsClient = TurmsClient();

// è¿æ¥åˆ°æœåŠ¡å™¨
await turmsClient.userService.login(userId, password);

// ä½¿ç”¨æ–°çš„ä¸šåŠ¡åŠŸèƒ½
try {
  final response = await turmsClient.customBusinessService.createCustomBusiness(
    businessName: 'æ–°ä¸šåŠ¡åŠŸèƒ½',
    businessData: '{"key": "value"}',
    targetUserIds: [123, 456],
    groupId: 789,
  );
  
  print('ä¸šåŠ¡åˆ›å»ºæˆåŠŸï¼ŒID: ${response.businessId}');
} catch (e) {
  print('ä¸šåŠ¡åˆ›å»ºå¤±è´¥: $e');
}
```

## 6. ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### MongoDB å®ä½“ç±»
```java
@Document(collection = "customBusiness")
public class CustomBusiness {
    @Id
    private Long id;
    
    @Field("business_name")
    @Indexed
    private String businessName;
    
    @Field("business_data") 
    private String businessData;
    
    @Field("creator_id")
    @Indexed
    private Long creatorId;
    
    @Field("target_user_ids")
    private Set<Long> targetUserIds;
    
    @Field("group_id")
    @Indexed
    private Long groupId;
    
    @Field("creation_date")
    @Indexed
    private Date creationDate;
    
    @Field("last_modified_date")
    private Date lastModifiedDate;
    
    @Field("status")
    @Indexed  
    private CustomBusinessStatus status;
    
    // æ„é€ å‡½æ•°ã€getterã€setter...
    
    public enum CustomBusinessStatus {
        ACTIVE,
        INACTIVE, 
        DELETED
    }
}
```

### Repository å®ç°
```java
@Repository
public class CustomBusinessRepository {
    
    private final MongoTemplate mongoTemplate;
    private final SnowflakeIdGenerator snowflakeIdGenerator;
    
    public CustomBusinessRepository(
            MongoTemplate mongoTemplate,
            SnowflakeIdGenerator snowflakeIdGenerator) {
        this.mongoTemplate = mongoTemplate;
        this.snowflakeIdGenerator = snowflakeIdGenerator;
    }
    
    public Mono<Long> createBusiness(
            Long creatorId, 
            String businessName, 
            String businessData,
            List<Long> targetUserIds,
            Long groupId) {
        
        CustomBusiness business = new CustomBusiness();
        business.setId(snowflakeIdGenerator.generateId());
        business.setCreatorId(creatorId);
        business.setBusinessName(businessName);
        business.setBusinessData(businessData);
        business.setTargetUserIds(targetUserIds != null ? new HashSet<>(targetUserIds) : null);
        business.setGroupId(groupId);
        business.setCreationDate(new Date());
        business.setStatus(CustomBusiness.CustomBusinessStatus.ACTIVE);
        
        return mongoTemplate.insert(business)
            .map(CustomBusiness::getId);
    }
    
    public Flux<CustomBusiness> findByCreatorId(Long creatorId) {
        Query query = Query.query(Criteria.where("creator_id").is(creatorId)
            .and("status").is(CustomBusiness.CustomBusinessStatus.ACTIVE));
        query.with(Sort.by(Sort.Direction.DESC, "creation_date"));
        
        return mongoTemplate.find(query, CustomBusiness.class);
    }
    
    public Mono<Boolean> deleteByIdAndCreatorId(Long businessId, Long creatorId) {
        Query query = Query.query(Criteria.where("id").is(businessId)
            .and("creator_id").is(creatorId));
        
        Update update = Update.update("status", CustomBusiness.CustomBusinessStatus.DELETED)
            .set("last_modified_date", new Date());
            
        return mongoTemplate.updateFirst(query, update, CustomBusiness.class)
            .map(result -> result.getModifiedCount() > 0);
    }
    
    public Mono<Boolean> existsByIdAndCreatorId(Long businessId, Long creatorId) {
        Query query = Query.query(Criteria.where("id").is(businessId)
            .and("creator_id").is(creatorId)
            .and("status").is(CustomBusiness.CustomBusinessStatus.ACTIVE));
            
        return mongoTemplate.exists(query, CustomBusiness.class);
    }
}
```

### æ•°æ®åº“ç´¢å¼•é…ç½®
```javascript
// MongoDB ç´¢å¼•åˆ›å»ºè„šæœ¬
db.customBusiness.createIndex({ "creator_id": 1, "creation_date": -1 });
db.customBusiness.createIndex({ "group_id": 1, "status": 1 });
db.customBusiness.createIndex({ "target_user_ids": 1, "status": 1 });
db.customBusiness.createIndex({ "business_name": "text" }); // æ”¯æŒæ–‡æœ¬æœç´¢
```

## 7. ğŸ”§ é…ç½®ç®¡ç†

### ä¸šåŠ¡é…ç½®å±æ€§
```java
@Data
@ConfigurationProperties("turms.service.custom-business")
public class CustomBusinessProperties {
    
    private boolean enabled = true;
    
    private int maxBusinessNameLength = 50;
    
    private int maxBusinessDataLength = 1000;
    
    private boolean allowAnonymousAccess = false;
    
    private int maxBusinessesPerUser = 100;
    
    private Duration businessCacheTtl = Duration.ofMinutes(30);
    
    private RateLimitProperties rateLimit = new RateLimitProperties();
    
    @Data
    public static class RateLimitProperties {
        private boolean enabled = true;
        private int requestsPerMinute = 10;
        private Duration windowSize = Duration.ofMinutes(1);
    }
}
```

### åº”ç”¨é…ç½®æ–‡ä»¶
```yaml
# application.yaml
turms:
  service:
    custom-business:
      enabled: true
      max-business-name-length: 50
      max-business-data-length: 1000
      allow-anonymous-access: false
      max-businesses-per-user: 100
      business-cache-ttl: PT30M
      rate-limit:
        enabled: true
        requests-per-minute: 10
        window-size: PT1M

# application-dev.yaml (å¼€å‘ç¯å¢ƒ)
turms:
  service:
    custom-business:
      max-businesses-per-user: 1000  # å¼€å‘ç¯å¢ƒæ”¾å®½é™åˆ¶
      rate-limit:
        requests-per-minute: 100

# application-prod.yaml (ç”Ÿäº§ç¯å¢ƒ)  
turms:
  service:
    custom-business:
      rate-limit:
        requests-per-minute: 5  # ç”Ÿäº§ç¯å¢ƒæ›´ä¸¥æ ¼
```

## 8. ğŸ§ª æµ‹è¯•

### å•å…ƒæµ‹è¯•
```java
@ExtendWith(MockitoExtension.class)
class CustomBusinessServiceTest {
    
    @Mock
    private CustomBusinessRepository customBusinessRepository;
    
    @Mock
    private TurmsPropertiesManager propertiesManager;
    
    @InjectMocks
    private CustomBusinessService customBusinessService;
    
    @Test
    void createCustomBusiness_shouldReturnBusinessId_whenValidRequest() {
        // Given
        Long requesterId = 1L;
        CreateCustomBusinessRequest request = CreateCustomBusinessRequest.newBuilder()
            .setBusinessName("æµ‹è¯•ä¸šåŠ¡")
            .setBusinessData("æµ‹è¯•æ•°æ®")
            .build();
            
        when(customBusinessRepository.createBusiness(any(), any(), any(), any(), any()))
            .thenReturn(Mono.just(123L));
            
        when(propertiesManager.getLocalProperties())
            .thenReturn(createMockProperties(true));
            
        // When
        StepVerifier.create(customBusinessService.createCustomBusiness(requesterId, request))
            // Then
            .assertNext(response -> {
                assertThat(response.getBusinessId()).isEqualTo(123L);
                assertThat(response.getTimestamp()).isPositive();
            })
            .verifyComplete();
    }
    
    @Test
    void createCustomBusiness_shouldThrowException_whenBusinessNameIsBlank() {
        // Given
        CreateCustomBusinessRequest request = CreateCustomBusinessRequest.newBuilder()
            .setBusinessName("")
            .build();
            
        // When & Then
        StepVerifier.create(customBusinessService.createCustomBusiness(1L, request))
            .expectError(TurmsBusinessException.class)
            .verify();
    }
    
    private TurmsProperties createMockProperties(boolean enabled) {
        TurmsProperties properties = new TurmsProperties();
        properties.getService().getCustomBusiness().setEnabled(enabled);
        return properties;
    }
}
```

### é›†æˆæµ‹è¯•
```java
@SpringBootTest
@TestPropertySource(properties = {
    "turms.service.custom-business.enabled=true",
    "turms.service.custom-business.max-businesses-per-user=10"
})
class CustomBusinessServiceIT extends BaseIntegrationTest {
    
    @Autowired
    private CustomBusinessService customBusinessService;
    
    @Autowired
    private CustomBusinessRepository customBusinessRepository;
    
    @Test
    void createCustomBusiness_shouldPersistToDatabaseCorrectly() {
        // Given
        Long requesterId = 1L;
        CreateCustomBusinessRequest request = CreateCustomBusinessRequest.newBuilder()
            .setBusinessName("é›†æˆæµ‹è¯•ä¸šåŠ¡")
            .setBusinessData("{\"test\": true}")
            .addTargetUserIds(100L)
            .addTargetUserIds(200L)
            .setGroupId(300L)
            .build();
            
        // When
        CreateCustomBusinessResponse response = customBusinessService
            .createCustomBusiness(requesterId, request)
            .block();
            
        // Then
        assertThat(response).isNotNull();
        assertThat(response.getBusinessId()).isPositive();
        
        // éªŒè¯æ•°æ®åº“ä¸­çš„æ•°æ®
        StepVerifier.create(customBusinessRepository.findByCreatorId(requesterId))
            .assertNext(business -> {
                assertThat(business.getBusinessName()).isEqualTo("é›†æˆæµ‹è¯•ä¸šåŠ¡");
                assertThat(business.getTargetUserIds()).containsExactly(100L, 200L);
                assertThat(business.getGroupId()).isEqualTo(300L);
            })
            .verifyComplete();
    }
}
```

### API æµ‹è¯•
```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
class CustomBusinessApiIT {
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @Test
    void createCustomBusiness_throughApi_shouldReturnSuccess() {
        // æ¨¡æ‹Ÿå®Œæ•´çš„ API è°ƒç”¨æµç¨‹
        TurmsRequest turmsRequest = TurmsRequest.newBuilder()
            .setCreateCustomBusinessRequest(
                CreateCustomBusinessRequest.newBuilder()
                    .setBusinessName("APIæµ‹è¯•ä¸šåŠ¡")
                    .setBusinessData("APIæµ‹è¯•æ•°æ®")
                    .build())
            .build();
            
        // å‘é€è¯·æ±‚å¹¶éªŒè¯å“åº”
        // ... API æµ‹è¯•é€»è¾‘
    }
}
```

## 9. ğŸ“š æ–‡æ¡£æ›´æ–°

### API æ–‡æ¡£
```markdown
## Custom Business API

### Create Custom Business
åˆ›å»ºè‡ªå®šä¹‰ä¸šåŠ¡å®ä¾‹ã€‚

**è¯·æ±‚ç±»å‹**: `CREATE_CUSTOM_BUSINESS_REQUEST`

**æƒé™è¦æ±‚**: å·²ç™»å½•ç”¨æˆ·

**è¯·æ±‚å‚æ•°**:
- `business_name` (string, å¿…å¡«): ä¸šåŠ¡åç§°ï¼Œæœ€å¤§é•¿åº¦50å­—ç¬¦
- `business_data` (string, å¯é€‰): ä¸šåŠ¡æ•°æ®ï¼Œæœ€å¤§é•¿åº¦1000å­—ç¬¦ï¼Œå»ºè®®ä½¿ç”¨JSONæ ¼å¼
- `target_user_ids` (int64[], å¯é€‰): ç›®æ ‡ç”¨æˆ·IDåˆ—è¡¨
- `group_id` (int64, å¯é€‰): å…³è”çš„ç¾¤ç»„ID

**å“åº”**:
- `business_id` (int64): åˆ›å»ºçš„ä¸šåŠ¡ID
- `timestamp` (int64): åˆ›å»ºæ—¶é—´æˆ³

**é”™è¯¯ç **:
- `ILLEGAL_ARGUMENT`: å‚æ•°ä¸åˆæ³•
- `DISABLED_FUNCTION`: åŠŸèƒ½å·²ç¦ç”¨
- `RATE_LIMITED`: è¯·æ±‚é¢‘ç‡è¿‡é«˜

**ç¤ºä¾‹**:
```javascript
const response = await turmsClient.customBusinessService.createCustomBusiness({
    businessName: "æˆ‘çš„ä¸šåŠ¡",
    businessData: JSON.stringify({type: "order", amount: 100}),
    targetUserIds: [123, 456]
});
```

### Update Custom Business  
æ›´æ–°è‡ªå®šä¹‰ä¸šåŠ¡å®ä¾‹ã€‚

**è¯·æ±‚ç±»å‹**: `UPDATE_CUSTOM_BUSINESS_REQUEST`

**æƒé™è¦æ±‚**: ä¸šåŠ¡åˆ›å»ºè€…

**è¯·æ±‚å‚æ•°**:
- `business_id` (int64, å¿…å¡«): ä¸šåŠ¡ID
- `business_name` (string, å¯é€‰): æ–°çš„ä¸šåŠ¡åç§°
- `business_data` (string, å¯é€‰): æ–°çš„ä¸šåŠ¡æ•°æ®

### Query Custom Businesses
æŸ¥è¯¢è‡ªå®šä¹‰ä¸šåŠ¡å®ä¾‹ã€‚

**è¯·æ±‚ç±»å‹**: `QUERY_CUSTOM_BUSINESS_REQUEST`

**æƒé™è¦æ±‚**: å·²ç™»å½•ç”¨æˆ·

**è¯·æ±‚å‚æ•°**:
- `limit` (int32, å¯é€‰): è¿”å›ç»“æœæ•°é‡é™åˆ¶ï¼Œé»˜è®¤50ï¼Œæœ€å¤§100
- `last_updated_date` (int64, å¯é€‰): æŸ¥è¯¢æŒ‡å®šæ—¶é—´ä¹‹åæ›´æ–°çš„ä¸šåŠ¡

**å“åº”**: ä¸šåŠ¡å®ä¾‹åˆ—è¡¨
```

### é…ç½®æ–‡æ¡£
```markdown
## Custom Business é…ç½®

### åŸºç¡€é…ç½®
```yaml
turms:
  service:
    custom-business:
      enabled: true  # æ˜¯å¦å¯ç”¨è‡ªå®šä¹‰ä¸šåŠ¡åŠŸèƒ½
      max-business-name-length: 50  # ä¸šåŠ¡åç§°æœ€å¤§é•¿åº¦
      max-business-data-length: 1000  # ä¸šåŠ¡æ•°æ®æœ€å¤§é•¿åº¦
      allow-anonymous-access: false  # æ˜¯å¦å…è®¸åŒ¿åè®¿é—®
      max-businesses-per-user: 100  # æ¯ä¸ªç”¨æˆ·æœ€å¤§ä¸šåŠ¡æ•°é‡
```

### æ€§èƒ½é…ç½®
```yaml
turms:
  service:
    custom-business:
      business-cache-ttl: PT30M  # ä¸šåŠ¡ç¼“å­˜è¿‡æœŸæ—¶é—´
      rate-limit:
        enabled: true
        requests-per-minute: 10  # æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ•°
        window-size: PT1M  # é™æµçª—å£å¤§å°
```
```

## ğŸ¯ å¼€å‘æœ€ä½³å®è·µ

### 1. ç‰ˆæœ¬å…¼å®¹æ€§
- **å‘åå…¼å®¹**: æ–°å­—æ®µä½¿ç”¨ `optional` æ ‡è®°
- **å­—æ®µç¼–å·**: æ°¸è¿œä¸è¦é‡å¤ä½¿ç”¨å·²åºŸå¼ƒçš„å­—æ®µç¼–å·
- **æšä¸¾æ‰©å±•**: ä¸ºæ–°çš„æšä¸¾å€¼é¢„ç•™ç¼–å·ç©ºé—´

### 2. é”™è¯¯å¤„ç†
- **ç»Ÿä¸€é”™è¯¯ç **: ä½¿ç”¨æ ‡å‡†çš„ `TurmsStatusCode`
- **æ¸…æ™°é”™è¯¯ä¿¡æ¯**: æä¾›æœ‰æ„ä¹‰çš„é”™è¯¯æè¿°
- **å›½é™…åŒ–æ”¯æŒ**: æ”¯æŒå¤šè¯­è¨€é”™è¯¯æ¶ˆæ¯

### 3. æ€§èƒ½ä¼˜åŒ–
- **æ•°æ®åº“ç´¢å¼•**: ä¸ºæŸ¥è¯¢å­—æ®µåˆ›å»ºé€‚å½“çš„ç´¢å¼•
- **ç¼“å­˜ç­–ç•¥**: å¯¹çƒ­ç‚¹æ•°æ®ä½¿ç”¨ç¼“å­˜
- **å“åº”å¼ç¼–ç¨‹**: ä¿æŒéé˜»å¡çš„ç¼–ç¨‹æ¨¡å¼
- **åˆ†é¡µæŸ¥è¯¢**: é¿å…ä¸€æ¬¡æ€§è¿”å›å¤§é‡æ•°æ®

### 4. å®‰å…¨è€ƒè™‘
- **æƒé™éªŒè¯**: åœ¨æ¯ä¸ªæ“ä½œä¸­éªŒè¯ç”¨æˆ·æƒé™
- **è¾“å…¥éªŒè¯**: ä¸¥æ ¼éªŒè¯æ‰€æœ‰è¾“å…¥å‚æ•°
- **SQLæ³¨å…¥é˜²æŠ¤**: ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
- **é™æµä¿æŠ¤**: é˜²æ­¢æ¶æ„è¯·æ±‚å’ŒDDoSæ”»å‡»

### 5. ç›‘æ§å’Œæ—¥å¿—
- **å…³é”®æ“ä½œæ—¥å¿—**: è®°å½•é‡è¦çš„ä¸šåŠ¡æ“ä½œ
- **æ€§èƒ½æŒ‡æ ‡**: ç›‘æ§å“åº”æ—¶é—´å’Œååé‡
- **é”™è¯¯è¿½è¸ª**: è®°å½•å’Œåˆ†æé”™è¯¯ä¿¡æ¯
- **ç”¨æˆ·è¡Œä¸º**: åˆ†æç”¨æˆ·ä½¿ç”¨æ¨¡å¼

### 6. æµ‹è¯•ç­–ç•¥
- **å•å…ƒæµ‹è¯•**: è¦†ç›–æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- **é›†æˆæµ‹è¯•**: éªŒè¯ç»„ä»¶é—´äº¤äº’
- **APIæµ‹è¯•**: æµ‹è¯•å®Œæ•´çš„è¯·æ±‚/å“åº”æµç¨‹
- **æ€§èƒ½æµ‹è¯•**: éªŒè¯ç³»ç»Ÿåœ¨è´Ÿè½½ä¸‹çš„è¡¨ç°

## ğŸ”„ æŒç»­æ”¹è¿›

### ç‰ˆæœ¬å‘å¸ƒæµç¨‹
1. **å¼€å‘é˜¶æ®µ**: åœ¨ dev åˆ†æ”¯å¼€å‘æ–°åŠŸèƒ½
2. **æµ‹è¯•é˜¶æ®µ**: åœ¨ test ç¯å¢ƒè¿›è¡Œå®Œæ•´æµ‹è¯•
3. **é¢„å‘å¸ƒ**: åœ¨ staging ç¯å¢ƒéªŒè¯
4. **ç”Ÿäº§å‘å¸ƒ**: ç°åº¦å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒ
5. **ç›‘æ§åé¦ˆ**: æŒç»­ç›‘æ§å’Œä¼˜åŒ–

### æ–‡æ¡£ç»´æŠ¤
- åŠæ—¶æ›´æ–° API æ–‡æ¡£
- ç»´æŠ¤é…ç½®è¯´æ˜æ–‡æ¡£
- æ›´æ–°éƒ¨ç½²å’Œè¿ç»´æ–‡æ¡£
- è®°å½•å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

é€šè¿‡éµå¾ªè¿™ä¸ªå®Œæ•´çš„å¼€å‘æŒ‡å—ï¼Œä½ å¯ä»¥åœ¨ Turms ç³»ç»Ÿä¸­æˆåŠŸæ·»åŠ æ–°çš„ä¸šåŠ¡åŠŸèƒ½ï¼ŒåŒæ—¶ä¿æŒç³»ç»Ÿçš„ä¸€è‡´æ€§ã€å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚