# Turms API网关系统架构设计文档

## 文档信息

| 项目 | 值 |
|------|-----|
| 文档名称 | Turms API网关系统架构设计文档 |
| 版本 | v1.0.0 |
| 创建日期 | 2025-01-19 |
| 最后更新 | 2025-01-19 |
| 文档状态 | 正式版 |
| 作者 | Turms开发团队 |

## 1. 概述

### 1.1 背景与目标

Turms即时通讯系统随着业务发展，需要支持多种业务场景：
- 即时通讯核心功能（WebSocket/TCP长连接）
- 用户标签管理系统（HTTP API）
- 社交关系服务（HTTP API）
- 内容管理服务（HTTP API）
- 互动功能服务（HTTP API）
- 推荐算法服务（HTTP API）

**设计目标：**
1. **统一入口管理** - 所有服务通过单一网关访问
2. **协议适配** - 同时支持WebSocket和HTTP协议
3. **安全控制** - 统一的认证授权和访问控制
4. **性能保障** - 限流、熔断、负载均衡
5. **可观测性** - 完整的监控、日志和链路追踪
6. **易扩展性** - 支持新服务的快速接入

### 1.2 技术选型

| 组件 | 选型 | 理由 |
|------|------|------|
| 网关框架 | Spring Cloud Gateway | 响应式架构，性能优异，生态完善 |
| 认证方案 | JWT | 无状态，易于扩展，支持分布式 |
| 限流存储 | Redis | 高性能，支持分布式限流 |
| 服务发现 | Consul | 成熟稳定，支持健康检查 |
| 熔断器 | Resilience4j | 轻量级，与Spring集成良好 |
| 监控 | Prometheus + Grafana | 业界标准，功能完整 |

## 2. 系统架构

### 2.1 整体架构图

```
                    ┌─────────────────┐
                    │   客户端应用     │
                    │  (Web/Mobile)   │
                    └─────────┬───────┘
                              │ HTTP/WebSocket
                              ▼
                    ┌─────────────────┐
                    │  Turms API网关   │
                    │   (Port 8080)   │
                    └─────────┬───────┘
                              │
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │ 长连接网关   │ │  业务服务    │ │  管理服务    │
    │turms-gateway│ │各种HTTP API │ │ turms-admin │
    └─────────────┘ └─────────────┘ └─────────────┘
```

### 2.2 服务层次架构

```
┌──────────────────────────────────────────────────────────┐
│                     API网关层                             │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐        │
│  │ 认证授权 │ │ 限流控制 │ │ 熔断降级 │ │ 日志监控 │        │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘        │
└──────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────┐
│                     服务路由层                            │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │
│  │WebSocket │ │ IM核心   │ │ 标签服务  │ │ 社交服务  │   │
│  │    代理   │ │   API    │ │   API    │ │   API    │   │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │
│  │ 内容服务  │ │ 互动服务  │ │ 推荐服务  │ │ 管理服务  │   │
│  │   API    │ │   API    │ │   API    │ │   API    │   │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │
└──────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────┐
│                    后端服务层                             │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │
│  │ Gateway  │ │ Service  │ │TagService│ │SocialSvc │   │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │
│  │ContentSvc│ │InteractSv│ │RecommendS│ │  Admin   │   │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │
└──────────────────────────────────────────────────────────┘
```

### 2.3 数据流架构

```
客户端请求 → API网关 → 路由匹配 → 认证校验 → 限流检查 → 熔断检查 → 后端服务
     ↓                                                            ↓
响应返回 ← 日志记录 ← 监控上报 ← 响应处理 ← 负载均衡 ← 服务调用 ← 请求转发
```

## 3. 核心组件设计

### 3.1 路由管理

#### 3.1.1 路由规则设计

| 路径模式 | 服务名称 | 端口 | 协议 | 说明 |
|---------|---------|------|------|------|
| `/websocket/**` | turms-gateway | 10510 | WebSocket | 长连接通道 |
| `/tcp/**` | turms-gateway | 9510 | HTTP | TCP代理 |
| `/api/v1/im/**` | turms-service | 8510 | HTTP | 即时通讯API |
| `/api/v1/tags/**` | turms-tag-service | 8085 | HTTP | 标签服务API |
| `/api/v1/social/**` | turms-social-service | 8086 | HTTP | 社交关系API |
| `/api/v1/content/**` | turms-content-service | 8087 | HTTP | 内容管理API |
| `/api/v1/interaction/**` | turms-interaction-service | 8088 | HTTP | 互动功能API |
| `/api/v1/recommendation/**` | turms-recommendation-service | 8089 | HTTP | 推荐服务API |
| `/admin/**` | turms-admin | 6510 | HTTP | 管理界面API |

#### 3.1.2 路由过滤器链

```
请求 → LoggingFilter → AuthenticationFilter → RateLimitFilter → CircuitBreakerFilter → LoadBalancerFilter → 后端服务
```

### 3.2 认证授权设计

#### 3.2.1 JWT Token结构

```json
{
  "header": {
    "alg": "HS512",
    "typ": "JWT"
  },
  "payload": {
    "sub": "用户ID",
    "role": "用户角色",
    "iat": "签发时间",
    "exp": "过期时间"
  },
  "signature": "签名"
}
```

#### 3.2.2 认证流程

```
客户端请求 → 提取Authorization头 → JWT校验 → 用户信息提取 → 权限检查 → 请求头注入 → 后端服务
```

#### 3.2.3 公开API列表

- `/api/v1/auth/**` - 认证相关API
- `/api/v1/public/**` - 公开API
- `/health` - 健康检查
- `/actuator/health` - Spring Actuator健康检查

### 3.3 限流设计

#### 3.3.1 限流策略

| 服务类型 | 限流键 | 速率限制 | 突发容量 | 说明 |
|---------|--------|----------|----------|------|
| 默认 | IP地址 | 10/秒 | 20 | 通用限流 |
| turms-service | IP地址 | 100/秒 | 200 | IM核心服务 |
| turms-tag-service | IP地址 | 50/秒 | 100 | 标签服务 |
| turms-social-service | IP地址 | 30/秒 | 60 | 社交服务 |
| turms-content-service | IP地址 | 20/秒 | 40 | 内容服务 |
| turms-interaction-service | IP地址 | 40/秒 | 80 | 互动服务 |
| turms-recommendation-service | IP地址 | 15/秒 | 30 | 推荐服务 |

#### 3.3.2 限流算法

使用Redis令牌桶算法：
- 令牌生成速率：每秒补充固定数量令牌
- 桶容量：突发请求容量
- 消费策略：每个请求消费1个令牌

### 3.4 熔断设计

#### 3.4.1 熔断器配置

| 参数 | 值 | 说明 |
|------|-----|------|
| 滑动窗口大小 | 10 | 统计窗口请求数 |
| 最小调用次数 | 5 | 触发熔断的最小请求数 |
| 失败率阈值 | 50% | 触发熔断的失败率 |
| 等待时间 | 30秒 | 熔断器开启状态持续时间 |
| 慢调用率阈值 | 50% | 慢调用触发熔断的比例 |
| 慢调用时间阈值 | 2秒 | 定义慢调用的时间阈值 |

#### 3.4.2 熔断状态转换

```
关闭状态 → (失败率达到阈值) → 开启状态 → (等待时间后) → 半开状态 → (成功/失败) → 关闭/开启状态
```

### 3.5 负载均衡设计

#### 3.5.1 负载均衡算法

- **默认算法**：轮询(Round Robin)
- **备选算法**：随机(Random)、加权轮询(Weighted Round Robin)
- **健康检查**：基于Spring Cloud LoadBalancer

#### 3.5.2 服务发现

- **开发环境**：静态配置
- **生产环境**：Consul动态发现
- **健康检查间隔**：10秒
- **不健康服务剔除**：3次失败后剔除

## 4. 监控与可观测性

### 4.1 监控指标

#### 4.1.1 业务指标

- 请求总数和QPS
- 响应时间分布
- 错误率和状态码分布
- 限流触发次数
- 熔断器状态变化

#### 4.1.2 系统指标

- JVM内存使用情况
- GC频率和耗时
- 线程池状态
- 连接池状态

#### 4.1.3 依赖服务指标

- 后端服务可用性
- 服务响应时间
- 服务错误率

### 4.2 日志设计

#### 4.2.1 日志级别

- **ERROR**：系统错误和异常
- **WARN**：警告信息和降级
- **INFO**：关键业务操作
- **DEBUG**：调试信息

#### 4.2.2 日志格式

```
%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n
```

#### 4.2.3 日志内容

```json
{
  "timestamp": "2025-01-19T10:30:00.000Z",
  "level": "INFO",
  "requestId": "REQ-1705659000000-123",
  "method": "GET",
  "uri": "/api/v1/tags/categories",
  "status": 200,
  "duration": 150,
  "userAgent": "Mozilla/5.0...",
  "clientIp": "192.168.1.100"
}
```

### 4.3 链路追踪

#### 4.3.1 追踪标识

- **Request-ID**：请求唯一标识
- **Trace-ID**：调用链追踪标识
- **Span-ID**：调用段标识

#### 4.3.2 追踪范围

- API网关处理过程
- 后端服务调用
- 数据库操作
- 缓存操作

## 5. 安全设计

### 5.1 传输安全

- **HTTPS**：生产环境强制使用HTTPS
- **WebSocket Secure**：WSS协议保护WebSocket连接
- **证书管理**：使用标准SSL/TLS证书

### 5.2 访问控制

#### 5.2.1 CORS配置

```yaml
# 开发环境
allowedOriginPatterns: "*"

# 生产环境
allowedOrigins:
  - "https://your-frontend-domain.com"
  - "https://your-mobile-app-domain.com"
```

#### 5.2.2 请求头控制

- **允许的方法**：GET, POST, PUT, DELETE, OPTIONS
- **允许的头部**：Authorization, Content-Type, X-Request-ID
- **暴露的头部**：X-Total-Count, X-Rate-Limit-Remaining

### 5.3 数据安全

- **敏感信息脱敏**：日志中不记录密码等敏感信息
- **JWT密钥管理**：定期轮换，长度至少32字符
- **请求体大小限制**：防止大请求攻击

## 6. 性能设计

### 6.1 性能目标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 响应时间 | P99 < 200ms | 99%的请求响应时间 |
| 吞吐量 | > 10,000 RPS | 每秒请求处理能力 |
| 可用性 | 99.9% | 年度可用性目标 |
| 错误率 | < 0.1% | 请求错误率 |

### 6.2 性能优化

#### 6.2.1 JVM优化

```bash
-Xms512m -Xmx1g
-XX:+UseG1GC
-XX:+UseStringDeduplication
-XX:MaxGCPauseMillis=100
-XX:+HeapDumpOnOutOfMemoryError
```

#### 6.2.2 连接池优化

```yaml
spring:
  data:
    redis:
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 2
          max-wait: 3000ms
```

#### 6.2.3 缓存策略

- **路由缓存**：缓存路由规则，减少路由匹配时间
- **JWT缓存**：缓存有效JWT，减少重复解析
- **服务列表缓存**：缓存健康服务列表

## 7. 部署架构

### 7.1 部署模式

#### 7.1.1 单机部署

```
API网关 → Redis → Consul → 后端服务
```

#### 7.1.2 集群部署

```
负载均衡器 → [API网关集群] → [Redis集群] → [Consul集群] → [后端服务集群]
```

### 7.2 容器化部署

#### 7.2.1 Docker镜像

- **基础镜像**：openjdk:21-jre-slim
- **镜像大小**：约200MB
- **启动时间**：约30秒

#### 7.2.2 Kubernetes部署

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: turms-api-gateway
spec:
  replicas: 3
  selector:
    matchLabels:
      app: turms-api-gateway
  template:
    metadata:
      labels:
        app: turms-api-gateway
    spec:
      containers:
      - name: api-gateway
        image: turms/api-gateway:latest
        ports:
        - containerPort: 8080
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
```

### 7.3 环境配置

#### 7.3.1 开发环境

- **服务发现**：禁用，使用静态配置
- **日志级别**：DEBUG
- **限流**：宽松设置
- **CORS**：允许所有来源

#### 7.3.2 测试环境

- **服务发现**：启用Consul
- **日志级别**：INFO
- **限流**：中等设置
- **监控**：完整监控栈

#### 7.3.3 生产环境

- **服务发现**：Consul集群
- **日志级别**：WARN
- **限流**：严格设置
- **安全**：完整安全配置

## 8. 运维管理

### 8.1 健康检查

#### 8.1.1 检查端点

- `GET /actuator/health` - 整体健康状态
- `GET /actuator/health/liveness` - 存活检查
- `GET /actuator/health/readiness` - 就绪检查

#### 8.1.2 健康指标

- JVM状态
- Redis连接状态
- Consul连接状态
- 后端服务可达性

### 8.2 配置管理

#### 8.2.1 配置热更新

- Spring Cloud Config
- Consul Config
- Kubernetes ConfigMap

#### 8.2.2 敏感配置

- JWT密钥通过环境变量注入
- 数据库密码使用Kubernetes Secret
- 证书文件挂载Volume

### 8.3 版本发布

#### 8.3.1 发布策略

- **蓝绿部署**：零停机时间发布
- **滚动更新**：渐进式替换实例
- **金丝雀发布**：小流量验证

#### 8.3.2 回滚策略

- 保留最近3个版本的镜像
- 自动化回滚脚本
- 数据库迁移回滚方案

## 9. 容灾设计

### 9.1 故障场景

#### 9.1.1 网关实例故障

- **检测**：负载均衡器健康检查
- **处理**：自动剔除故障实例
- **恢复**：自动重启或手动干预

#### 9.1.2 依赖服务故障

- **Redis故障**：降级为内存限流
- **Consul故障**：使用缓存的服务列表
- **后端服务故障**：熔断器开启，返回降级响应

### 9.2 数据备份

#### 9.2.1 配置备份

- 路由配置定期备份
- 限流配置版本控制
- 监控配置代码化

#### 9.2.2 日志备份

- 集中日志收集
- 日志轮转和归档
- 长期存储策略

### 9.3 灾备方案

#### 9.3.1 同城灾备

- 双机房部署
- 数据实时同步
- 自动故障切换

#### 9.3.2 异地灾备

- 跨地区备份
- 定期灾备演练
- RTO/RPO目标设定

## 10. 扩展性设计

### 10.1 水平扩展

#### 10.1.1 网关扩展

- 无状态设计，支持任意扩展
- 基于CPU和内存使用率自动扩展
- 最小实例数：2，最大实例数：10

#### 10.1.2 依赖服务扩展

- Redis集群模式
- Consul集群部署
- 后端服务独立扩展

### 10.2 功能扩展

#### 10.2.1 插件机制

- 自定义过滤器开发
- 动态加载插件
- 插件配置管理

#### 10.2.2 协议扩展

- gRPC协议支持
- GraphQL协议支持
- 自定义协议适配

### 10.3 新服务接入

#### 10.3.1 接入流程

1. 服务注册到Consul
2. 配置路由规则
3. 设置限流参数
4. 配置熔断器
5. 部署和测试

#### 10.3.2 接入模板

```yaml
- id: new-service-api
  uri: lb://new-service
  predicates:
    - Path=/api/v1/newservice/**
  filters:
    - StripPrefix=3
    - name: CircuitBreaker
      args:
        name: new-service
        fallbackUri: forward:/fallback/new-service
    - name: RequestRateLimiter
      args:
        rate-limiter: "#{@redisRateLimiter}"
        key-resolver: "#{@ipKeyResolver}"
```

---

**文档维护**

本文档需要在以下情况下更新：
- 架构重大变更
- 新功能添加
- 性能参数调整
- 安全策略变化

**联系方式**

如有疑问或建议，请联系Turms开发团队。