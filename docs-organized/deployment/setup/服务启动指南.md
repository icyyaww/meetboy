# Turms 微服务启动指南

## 启动顺序说明

### 架构依赖关系
```
客户端请求
    ↓
turms-api-gateway (统一API网关) :8080
    ↓
┌─────────────────────────────────────────────────┐
│  turms-gateway (WebSocket/TCP网关) :9510/10510  │
│  turms-service (核心IM服务) :8510                │
│  turms-tag-service (标签服务) :8085              │
│  turms-social-service (社交关系服务) :8086       │
└─────────────────────────────────────────────────┘
    ↓
基础设施 (Redis, MongoDB, Consul)
```

## 1. 基础设施服务启动

### MongoDB (必需)
```bash
# 使用Docker启动MongoDB
docker run -d \
  --name turms-mongodb \
  -p 27017:27017 \
  -e MONGO_INITDB_ROOT_USERNAME=turms \
  -e MONGO_INITDB_ROOT_PASSWORD=turms \
  mongo:latest

# 或使用本地安装
sudo systemctl start mongod
```

### Redis (API网关限流必需)
```bash
# 使用Docker启动Redis
docker run -d \
  --name turms-redis \
  -p 6379:6379 \
  redis:latest

# 或使用本地安装
sudo systemctl start redis
```

### Consul (生产环境，开发环境可选)
```bash
# 开发环境启动Consul (可选)
consul agent -dev -client=0.0.0.0 -ui
```

## 2. 核心服务启动

### 第一步：启动 turms-service (核心IM服务)
```bash
cd /home/icyyaww/program/meetboy

# 编译并启动
sudo -u icyyaww mvn clean compile -pl turms-service
sudo -u icyyaww mvn spring-boot:run -pl turms-service -Dspring-boot.run.profiles=dev

# 验证启动
curl http://localhost:8510/actuator/health
```

### 第二步：启动 turms-tag-service (标签服务)
```bash
# 编译并启动
sudo -u icyyaww mvn clean compile -pl turms-tag-service
sudo -u icyyaww mvn spring-boot:run -pl turms-tag-service -Dspring-boot.run.profiles=dev

# 验证启动
curl http://localhost:8085/actuator/health
```

### 第三步：启动 turms-social-service (社交关系服务)
```bash
# 编译并启动
sudo -u icyyaww mvn clean compile -pl turms-social-service
sudo -u icyyaww mvn spring-boot:run -pl turms-social-service -Dspring-boot.run.profiles=dev

# 验证启动
curl http://localhost:8086/social/health
```

### 第四步：启动 turms-gateway (WebSocket/TCP网关)
```bash
# 编译并启动
sudo -u icyyaww mvn clean compile -pl turms-gateway
sudo -u icyyaww mvn spring-boot:run -pl turms-gateway -Dspring-boot.run.profiles=dev

# 验证启动
curl http://localhost:9510/actuator/health
```

### 第五步：启动 turms-api-gateway (API网关)
```bash
# 编译并启动
sudo -u icyyaww mvn clean compile -pl turms-api-gateway
sudo -u icyyaww mvn spring-boot:run -pl turms-api-gateway -Dspring-boot.run.profiles=dev

# 验证启动
curl http://localhost:8080/actuator/health
```

## 3. 启动验证

### 检查所有服务状态
```bash
# 检查端口占用情况
ss -tlnp | grep -E ":(8080|8085|8086|8510|9510|10510)"

# 预期输出：
# :8080  - turms-api-gateway
# :8085  - turms-tag-service  
# :8086  - turms-social-service
# :8510  - turms-service
# :9510  - turms-gateway (HTTP)
# :10510 - turms-gateway (WebSocket)
```

### API网关路由测试
```bash
# 通过API网关访问各个服务
curl http://localhost:8080/actuator/health                    # API网关自身
curl http://localhost:8080/api/v1/im/actuator/health         # 通过网关访问IM服务
curl http://localhost:8080/api/v1/tags/actuator/health       # 通过网关访问标签服务
curl http://localhost:8080/api/v1/social/health              # 通过网关访问社交服务

# 直接访问各个服务
curl http://localhost:8510/actuator/health                   # IM服务
curl http://localhost:8085/actuator/health                   # 标签服务
curl http://localhost:8086/social/health                     # 社交服务
```

## 4. 开发环境快速启动脚本

### 一键启动所有服务 (start-all.sh)
```bash
#!/bin/bash

echo "=== 启动 Turms 微服务集群 ==="

# 检查基础设施
echo "检查基础设施服务..."
if ! pgrep -f "redis-server" > /dev/null; then
    echo "启动 Redis..."
    redis-server --daemonize yes
fi

if ! pgrep -f "mongod" > /dev/null; then
    echo "启动 MongoDB..."
    sudo systemctl start mongod
fi

echo "等待基础设施就绪..."
sleep 3

# 启动核心服务
echo "启动 turms-service..."
cd /home/icyyaww/program/meetboy
sudo -u icyyaww mvn spring-boot:run -pl turms-service -Dspring-boot.run.profiles=dev &
sleep 10

echo "启动 turms-tag-service..."
sudo -u icyyaww mvn spring-boot:run -pl turms-tag-service -Dspring-boot.run.profiles=dev &
sleep 8

echo "启动 turms-social-service..."
sudo -u icyyaww mvn spring-boot:run -pl turms-social-service -Dspring-boot.run.profiles=dev &
sleep 8

echo "启动 turms-gateway..."
sudo -u icyyaww mvn spring-boot:run -pl turms-gateway -Dspring-boot.run.profiles=dev &
sleep 8

echo "启动 turms-api-gateway..."
sudo -u icyyaww mvn spring-boot:run -pl turms-api-gateway -Dspring-boot.run.profiles=dev &
sleep 5

echo "=== 所有服务启动完成 ==="
echo "API网关: http://localhost:8080"
echo "管理界面: http://localhost:8080/actuator"
```

## 5. 服务停止

### 停止所有服务
```bash
# 找到并停止所有Java进程
pkill -f "turms-"

# 或者单独停止
pkill -f "turms-service"
pkill -f "turms-tag-service" 
pkill -f "turms-social-service"
pkill -f "turms-gateway"
pkill -f "turms-api-gateway"
```

## 6. 故障排查

### 常见问题
1. **端口冲突**: 检查端口是否被占用
2. **内存不足**: 调整JVM内存参数
3. **依赖服务未启动**: 确保Redis、MongoDB先启动
4. **配置文件错误**: 检查application.yml配置

### 日志查看
```bash
# 各服务日志位置
tail -f logs/turms-service.log
tail -f logs/turms-tag-service.log
tail -f logs/turms-social-service.log
tail -f logs/turms-gateway.log
tail -f logs/turms-api-gateway.log
```

## 7. 生产环境注意事项

1. **使用Consul进行服务发现**
2. **配置外部配置中心**
3. **使用容器化部署 (Docker/Kubernetes)**
4. **配置监控和日志收集**
5. **设置健康检查和自动重启**
6. **配置负载均衡**

## 启动顺序总结

```
1. Redis + MongoDB (基础设施)
2. turms-service (核心业务，其他服务的依赖)
3. turms-tag-service (标签服务)
4. turms-social-service (社交关系服务)
5. turms-gateway (WebSocket网关)
6. turms-api-gateway (最后启动，统一入口)
```

这个顺序确保了服务间的依赖关系得到正确满足，避免启动时的连接错误。