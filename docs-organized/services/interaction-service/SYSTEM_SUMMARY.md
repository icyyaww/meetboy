# Turmsäº’åŠ¨æœåŠ¡ç³»ç»Ÿæ€»ç»“

## é¡¹ç›®æ¦‚è¿°

åŸºäºç”¨æˆ·éœ€æ±‚ï¼Œæˆ‘ä»¬æˆåŠŸå®ç°äº†**turms-interaction-service**äº’åŠ¨æœåŠ¡æ¨¡å—ï¼Œé‡‡ç”¨ç°ä»£åŒ–çš„æŠ€æœ¯æ¶æ„ï¼Œæ”¯æŒé«˜å¹¶å‘ç‚¹èµå’Œè¯„è®ºåŠŸèƒ½ã€‚

## æŠ€æœ¯æ¶æ„æ€»è§ˆ

### æ•´ä½“è®¾è®¡ç†å¿µ
- **å¾®æœåŠ¡æ¶æ„**: ç‹¬ç«‹çš„äº’åŠ¨æœåŠ¡æ¨¡å—
- **å¤šæ•°æ®åº“ç­–ç•¥**: Redis + MySQL + MongoDBååŒå·¥ä½œ  
- **é«˜æ€§èƒ½ä¼˜åŒ–**: é’ˆå¯¹ä¸åŒä¸šåŠ¡åœºæ™¯é€‰æ‹©æœ€ä¼˜æ–¹æ¡ˆ
- **å¼‚æ­¥å¤„ç†**: ç”¨æˆ·ä½“éªŒä¼˜å…ˆï¼Œåå°å¼‚æ­¥å¤„ç†

### æŠ€æœ¯æ ˆé€‰å‹

**åç«¯æ¡†æ¶**:
- Spring Boot 3.4.4 + WebFlux (å“åº”å¼ç¼–ç¨‹)
- Java 21 (ç°ä»£Javaç‰¹æ€§)
- Maven æ„å»ºç®¡ç†

**æ•°æ®å­˜å‚¨**:
- **Redis**: ç‚¹èµç³»ç»Ÿä¸»å­˜å‚¨ + è¯„è®ºåˆ—è¡¨ç¼“å­˜
- **MySQL**: è¯„è®ºç³»ç»Ÿä¸»å­˜å‚¨ + ç‚¹èµæ•°æ®æŒä¹…åŒ–
- **MongoDB**: äº‹ä»¶å­˜å‚¨ + å¤æ‚æ•°æ®ç»“æ„

**æ¶ˆæ¯é˜Ÿåˆ—**:
- Apache Kafka (äº‹ä»¶é©±åŠ¨æ¶æ„)
- Project Reactor (å“åº”å¼æµå¤„ç†)

## æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. é«˜å¹¶å‘ç‚¹èµç³»ç»Ÿ â­

**æ¶æ„**: Redisä¸»å¯¼ + MySQLæŒä¹…åŒ–

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… **æ¯«ç§’çº§å“åº”**: Rediså†…å­˜æ“ä½œï¼ŒZSetå¤©ç„¶æ’åº
- âœ… **åŸå­æ€§ä¿è¯**: Luaè„šæœ¬ç¡®ä¿æ“ä½œåŸå­æ€§
- âœ… **æ•°æ®æŒä¹…åŒ–**: MySQLå¼‚æ­¥æŒä¹…åŒ–ï¼Œæ”¯æŒæ•°æ®æ¢å¤
- âœ… **é«˜å¹¶å‘æ”¯æŒ**: æ”¯æŒç™¾ä¸‡çº§å¹¶å‘ç‚¹èµæ“ä½œ

**Rediså­˜å‚¨è®¾è®¡**:
```
like:count:POST:123 â†’ 1500                    # ç‚¹èµè®¡æ•°
like:user:1001 â†’ {POST:123, COMMENT:456}      # ç”¨æˆ·ç‚¹èµé›†åˆ
like:target:POST:123 â†’ {1001, 1002, 1003}    # ç›®æ ‡ç‚¹èµç”¨æˆ·é›†åˆ
```

**APIæ¥å£**:
```bash
# ç‚¹èµåˆ‡æ¢ (æ¯«ç§’çº§å“åº”)
POST /api/v2/likes/toggle

# ç‚¹èµè®¡æ•°æŸ¥è¯¢
GET /api/v2/likes/count?targetType=POST&targetId=123

# æ‰¹é‡çŠ¶æ€æ£€æŸ¥
POST /api/v2/likes/batch/status
```

### 2. ä¸€çº§è¯„è®ºç³»ç»Ÿ ğŸ“

**æ¶æ„**: MySQLä¸»å¯¼ + Redisç¼“å­˜

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… **ç®€å•å¯é **: ä¸€çº§è¯„è®ºç»“æ„ï¼Œé¿å…å¤æ‚å±‚çº§æŸ¥è¯¢
- âœ… **æ€§èƒ½ä¼˜åŒ–**: æ™ºèƒ½ç´¢å¼•è®¾è®¡ + Redisç¼“å­˜åŠ é€Ÿ
- âœ… **æ˜“äºæ‰©å±•**: æ ‡å‡†SQLæŸ¥è¯¢ï¼Œä¾¿äºåŠŸèƒ½æ‰©å±•
- âœ… **æ•°æ®ä¸€è‡´æ€§**: æ•°æ®åº“è§¦å‘å™¨è‡ªåŠ¨ç»´æŠ¤è®¡æ•°

**MySQLè¡¨è®¾è®¡**:
```sql
-- è¯„è®ºä¸»è¡¨
comments: id, article_id, user_id, content, like_count, created_at

-- è®¡æ•°æ±‡æ€»è¡¨  
comment_counts: article_id, comment_count, approved_count, last_comment_at
```

**Redisç¼“å­˜è®¾è®¡**:
```
comment:list:article_001:latest:0:20 â†’ [è¯„è®ºåˆ—è¡¨]    # 2å°æ—¶TTL
comment:count:article_001 â†’ 15                        # è¯„è®ºè®¡æ•°
comment:hot:article_001 â†’ [çƒ­é—¨è¯„è®º]                  # 30åˆ†é’ŸTTL
```

**APIæ¥å£**:
```bash
# æ·»åŠ è¯„è®º
POST /api/v2/comments

# è¯„è®ºåˆ—è¡¨ (æ”¯æŒåˆ†é¡µæ’åº)
GET /api/v2/comments/article/{articleId}?page=0&size=20&sortBy=latest

# çƒ­é—¨è¯„è®º
GET /api/v2/comments/hot/{articleId}?limit=10
```

### 3. äº‹ä»¶é©±åŠ¨æ¶æ„ ğŸš€

**ç‰¹æ€§**:
- Kafkaæ¶ˆæ¯é˜Ÿåˆ—
- å¼‚æ­¥äº‹ä»¶å¤„ç†
- ç³»ç»Ÿè§£è€¦è®¾è®¡
- å¯è§‚æµ‹æ€§æ”¯æŒ

## æ•°æ®åº“è®¾è®¡è¯¦è§£

### MySQLè¡¨ç»“æ„

#### ç‚¹èµç³»ç»Ÿè¡¨
```sql
-- ç‚¹èµè®°å½•è¡¨ (æŒä¹…åŒ–å®¡è®¡)
likes: id, user_id, target_type, target_id, device_info, created_at

-- ç‚¹èµè®¡æ•°è¡¨ (Redisæ•…éšœæ¢å¤)  
like_counts: target_type, target_id, like_count, last_sync_at

-- åŒæ­¥æ—¥å¿—è¡¨ (æ•°æ®è¿½è¸ª)
like_sync_log: sync_type, status, error_message, retry_count
```

#### è¯„è®ºç³»ç»Ÿè¡¨
```sql
-- è¯„è®ºä¸»è¡¨ (ç®€å•é«˜æ•ˆ)
comments: id, article_id, user_id, username, content, status, like_count, created_at

-- è¯„è®ºè®¡æ•°è¡¨ (è‡ªåŠ¨ç»´æŠ¤)
comment_counts: article_id, comment_count, approved_count, last_comment_at
```

### ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

```sql
-- ç‚¹èµç³»ç»Ÿç´¢å¼•
UNIQUE KEY uk_user_target (user_id, target_type, target_id)  # é˜²é‡å¤ç‚¹èµ
INDEX idx_target_created (target_type, target_id, created_at) # ç›®æ ‡æŸ¥è¯¢
INDEX idx_user_created (user_id, created_at)                # ç”¨æˆ·å†å²

-- è¯„è®ºç³»ç»Ÿç´¢å¼•  
INDEX idx_article_created (article_id, created_at DESC)     # æ–‡ç« è¯„è®ºæ—¶é—´æ’åº
INDEX idx_article_likes (article_id, like_count DESC)       # æ–‡ç« è¯„è®ºçƒ­åº¦æ’åº
INDEX idx_user_created (user_id, created_at DESC)           # ç”¨æˆ·è¯„è®ºå†å²
```

## æ€§èƒ½ä¼˜åŒ–

### Redisä¼˜åŒ–ç­–ç•¥

1. **è¿æ¥æ± é…ç½®**:
   ```yaml
   max-active: 200    # æœ€å¤§è¿æ¥æ•°
   max-idle: 20       # æœ€å¤§ç©ºé—²è¿æ¥  
   min-idle: 5        # æœ€å°ç©ºé—²è¿æ¥
   ```

2. **Luaè„šæœ¬ä¼˜åŒ–**: åŸå­æ“ä½œé¿å…ç«æ€æ¡ä»¶
3. **è¿‡æœŸç­–ç•¥**: åˆç†çš„TTLè®¾ç½®ï¼Œé¿å…å†…å­˜æ³„æ¼
4. **é”®å‘½åä¼˜åŒ–**: ç»“æ„åŒ–å‘½åï¼Œä¾¿äºç®¡ç†

### MySQLä¼˜åŒ–ç­–ç•¥

1. **è¿æ¥æ± ä¼˜åŒ–**:
   ```yaml
   maximum-pool-size: 20
   minimum-idle: 5
   idle-timeout: 300000
   ```

2. **ç´¢å¼•ä¼˜åŒ–**: å¤åˆç´¢å¼•è¦†ç›–å¸¸ç”¨æŸ¥è¯¢
3. **åˆ†åŒºç­–ç•¥**: æŒ‰æ—¶é—´åˆ†åŒºå¤§è¡¨ï¼ˆå¯é€‰ï¼‰
4. **å¼‚æ­¥å†™å…¥**: ä¸é˜»å¡ç”¨æˆ·è¯·æ±‚

## ç³»ç»Ÿç›‘æ§

### æ€§èƒ½æŒ‡æ ‡

**å“åº”æ—¶é—´ç›®æ ‡**:
- ç‚¹èµæ“ä½œ: P95 < 10ms (Redis)
- è¯„è®ºæŸ¥è¯¢: P95 < 50ms (ç¼“å­˜å‘½ä¸­)
- è¯„è®ºæ·»åŠ : P95 < 200ms (MySQLå†™å…¥)

**å¹¶å‘èƒ½åŠ›**:
- ç‚¹èµQPS: 100,000/ç§’
- è¯„è®ºæŸ¥è¯¢QPS: 50,000/ç§’  
- è¯„è®ºæ·»åŠ QPS: 5,000/ç§’

### ç›‘æ§æŒ‡æ ‡

```yaml
# ä¸šåŠ¡æŒ‡æ ‡
- ç‚¹èµæˆåŠŸç‡ >99.9%
- è¯„è®ºæ·»åŠ æˆåŠŸç‡ >99.5%
- ç¼“å­˜å‘½ä¸­ç‡ >80%

# æŠ€æœ¯æŒ‡æ ‡
- Rediså†…å­˜ä½¿ç”¨ç‡ <85%
- MySQLè¿æ¥æ± ä½¿ç”¨ç‡ <80%
- APIå“åº”æ—¶é—´ P95<100ms
```

## éƒ¨ç½²æ¶æ„

### Dockerå®¹å™¨åŒ–

**MySQLéƒ¨ç½²**:
```bash
# å¯åŠ¨MySQLå®¹å™¨
docker-compose -f docker-compose.mysql.yml up -d

# åˆå§‹åŒ–æ•°æ®åº“å’Œè¡¨ç»“æ„
docker exec turms-mysql mysql -u turms -pturms123456 < mysql/init/*.sql
```

**æœåŠ¡é…ç½®**:
```yaml
# application.yml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/turms_interaction
    username: turms
    password: turms123456
  data:
    redis:
      host: localhost
      port: 6379
```

### å¤šç¯å¢ƒæ”¯æŒ

- **å¼€å‘ç¯å¢ƒ**: è°ƒè¯•æ¨¡å¼ï¼Œè¯¦ç»†æ—¥å¿—
- **æµ‹è¯•ç¯å¢ƒ**: æ¨¡æ‹Ÿç”Ÿäº§ï¼Œæ€§èƒ½æµ‹è¯•
- **ç”Ÿäº§ç¯å¢ƒ**: é«˜å¯ç”¨é…ç½®ï¼Œç›‘æ§å‘Šè­¦

## APIæ–‡æ¡£

### ç‚¹èµç³»ç»ŸAPI

| æ¥å£ | æ–¹æ³• | æè¿° | å“åº”æ—¶é—´ |
|------|------|------|----------|
| `/api/v2/likes/toggle` | POST | åˆ‡æ¢ç‚¹èµçŠ¶æ€ | <10ms |
| `/api/v2/likes/count` | GET | æŸ¥è¯¢ç‚¹èµè®¡æ•° | <5ms |
| `/api/v2/likes/status` | GET | æ£€æŸ¥ç‚¹èµçŠ¶æ€ | <5ms |
| `/api/v2/likes/batch/status` | POST | æ‰¹é‡çŠ¶æ€æ£€æŸ¥ | <20ms |
| `/api/v2/likes/users` | GET | ç‚¹èµç”¨æˆ·åˆ—è¡¨ | <30ms |

### è¯„è®ºç³»ç»ŸAPI

| æ¥å£ | æ–¹æ³• | æè¿° | å“åº”æ—¶é—´ |
|------|------|------|----------|
| `/api/v2/comments` | POST | æ·»åŠ è¯„è®º | <200ms |
| `/api/v2/comments/article/{id}` | GET | æ–‡ç« è¯„è®ºåˆ—è¡¨ | <50ms |
| `/api/v2/comments/count/{id}` | GET | è¯„è®ºè®¡æ•° | <10ms |
| `/api/v2/comments/hot/{id}` | GET | çƒ­é—¨è¯„è®º | <30ms |
| `/api/v2/comments/{id}` | PUT/DELETE | æ›´æ–°/åˆ é™¤è¯„è®º | <100ms |

## æµ‹è¯•éªŒè¯

### åŠŸèƒ½æµ‹è¯•ç¤ºä¾‹

```bash
# ç‚¹èµåŠŸèƒ½æµ‹è¯•
curl -X POST http://localhost:8530/api/v2/likes/toggle \
  -H "Content-Type: application/json" \
  -d '{"userId":1001,"targetType":"POST","targetId":"123"}'

# è¯„è®ºåŠŸèƒ½æµ‹è¯•  
curl -X POST http://localhost:8530/api/v2/comments \
  -H "Content-Type: application/json" \
  -d '{"articleId":"article_001","userId":1001,"username":"test","content":"æµ‹è¯•è¯„è®º"}'

# æ€§èƒ½æµ‹è¯•
ab -n 10000 -c 100 http://localhost:8530/api/v2/likes/count?targetType=POST&targetId=123
```

### æ•°æ®éªŒè¯

```sql
-- éªŒè¯MySQLæ•°æ®
SELECT COUNT(*) FROM likes;
SELECT COUNT(*) FROM comments;
SELECT article_id, comment_count FROM comment_counts;

-- éªŒè¯Redisæ•°æ®  
redis-cli keys "like:*"
redis-cli keys "comment:*"
```

## æ¶æ„ä¼˜åŠ¿

### 1. æ€§èƒ½ä¼˜åŠ¿
- **Rediså†…å­˜æ“ä½œ**: å¾®ç§’çº§ç‚¹èµå“åº”
- **æ™ºèƒ½ç¼“å­˜ç­–ç•¥**: å‡å°‘æ•°æ®åº“å‹åŠ›  
- **å¼‚æ­¥å¤„ç†**: ç”¨æˆ·æ„ŸçŸ¥å“åº”å¿«
- **æ‰¹é‡ä¼˜åŒ–**: æå‡ååé‡

### 2. å¯é æ€§ä¼˜åŠ¿
- **æ•°æ®æŒä¹…åŒ–**: MySQLä¿è¯æ•°æ®ä¸ä¸¢å¤±
- **æ•…éšœæ¢å¤**: Redisæ•…éšœæ—¶MySQLå…œåº•
- **äº‹åŠ¡ä¿è¯**: æ•°æ®ä¸€è‡´æ€§ä¿éšœ
- **ç›‘æ§å‘Šè­¦**: åŠæ—¶å‘ç°å’Œå¤„ç†é—®é¢˜

### 3. æ‰©å±•æ€§ä¼˜åŠ¿
- **æ°´å¹³æ‰©å±•**: æ”¯æŒåˆ†ç‰‡å’Œé›†ç¾¤
- **åŠŸèƒ½æ‰©å±•**: ç®€å•æ¶æ„ä¾¿äºæ·»åŠ æ–°åŠŸèƒ½
- **æŠ€æœ¯å‡çº§**: æˆç†ŸæŠ€æœ¯æ ˆï¼Œä¾¿äºç»´æŠ¤
- **å›¢é˜Ÿåä½œ**: æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†

### 4. ä¸šåŠ¡ä¼˜åŠ¿
- **ç”¨æˆ·ä½“éªŒ**: æµç•…çš„äº’åŠ¨ä½“éªŒ
- **è¿è¥ä»·å€¼**: ä¸°å¯Œçš„æ•°æ®ç»Ÿè®¡
- **æˆæœ¬æ§åˆ¶**: é«˜æ•ˆçš„èµ„æºåˆ©ç”¨
- **å¿«é€Ÿè¿­ä»£**: ä¾¿äºåŠŸèƒ½å¿«é€Ÿä¸Šçº¿

## æœªæ¥è§„åˆ’

### çŸ­æœŸä¼˜åŒ–(1-3ä¸ªæœˆ)
- [ ] å®ç°æ›´ç²¾ç»†çš„ç¼“å­˜ç­–ç•¥
- [ ] æ·»åŠ é™æµå’Œé˜²åˆ·æœºåˆ¶
- [ ] å®Œå–„ç›‘æ§å‘Šè­¦ä½“ç³»
- [ ] æ€§èƒ½å‹æµ‹å’Œè°ƒä¼˜

### ä¸­æœŸæ‰©å±•(3-6ä¸ªæœˆ)  
- [ ] æ”¯æŒäºŒçº§å›å¤åŠŸèƒ½
- [ ] é›†æˆå†…å®¹å®¡æ ¸æœåŠ¡
- [ ] å®ç°å®æ—¶æ¨é€é€šçŸ¥
- [ ] æ·»åŠ ç”¨æˆ·è¡Œä¸ºåˆ†æ

### é•¿æœŸè§„åˆ’(6-12ä¸ªæœˆ)
- [ ] æ™ºèƒ½æ¨èç®—æ³•
- [ ] å¤šåª’ä½“è¯„è®ºæ”¯æŒ
- [ ] å›½é™…åŒ–å¤šè¯­è¨€
- [ ] AIå†…å®¹ç†è§£

## æ€»ç»“

turms-interaction-serviceäº’åŠ¨æœåŠ¡ç³»ç»ŸæˆåŠŸå®ç°äº†ä»¥ä¸‹ç›®æ ‡ï¼š

âœ… **é«˜æ€§èƒ½**: Redisä¸»å¯¼çš„ç‚¹èµç³»ç»Ÿï¼Œæ¯«ç§’çº§å“åº”  
âœ… **é«˜å¯é **: MySQLæŒä¹…åŒ– + å®Œå–„çš„å®¹é”™æœºåˆ¶  
âœ… **é«˜å¯ç”¨**: å¤šå±‚ç¼“å­˜ + å¼‚æ­¥å¤„ç†æ¶æ„  
âœ… **æ˜“ç»´æŠ¤**: æ¸…æ™°çš„æ¨¡å—è®¾è®¡ + æ ‡å‡†æŠ€æœ¯æ ˆ  
âœ… **å¯æ‰©å±•**: å¾®æœåŠ¡æ¶æ„ + æ°´å¹³æ‰©å±•èƒ½åŠ›  

è¯¥ç³»ç»Ÿä¸ºäº’åŠ¨åŠŸèƒ½æä¾›äº†å¼ºå¤§çš„æŠ€æœ¯æ”¯æ’‘ï¼Œèƒ½å¤Ÿæ»¡è¶³å¤§è§„æ¨¡ç”¨æˆ·çš„ä½¿ç”¨éœ€æ±‚ï¼Œä¸ºä¸šåŠ¡å‘å±•å¥ å®šäº†åšå®çš„æŠ€æœ¯åŸºç¡€ã€‚